generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////
// BlueShark Database Schema (Prisma Models)
//////////////////////////////////////////////////

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  role      Role
  createdAt DateTime @default(now())
}

model rolls {
  id          Int           @id @default(autoincrement())
  name        String
  quantity    Int
  unit        String
  color       String
  vendor_id   Int?
  vendor      vendors?      @relation(fields: [vendor_id], references: [id])
  batches     batches[]
  sub_batches sub_batches[]
}

model batches {
  id          Int           @id @default(autoincrement())
  roll_id     Int?
  name        String
  quantity    Int
  unit        String
  color       String
  vendor_id   Int?
  vendor      vendors?      @relation(fields: [vendor_id], references: [id])
  roll        rolls?        @relation(fields: [roll_id], references: [id])
  sub_batches sub_batches[]
}

model sub_batches {
  id               Int      @id @default(autoincrement())
  roll_id          Int?
  batch_id         Int?
  name             String
  estimated_pieces Int
  expected_items   Int
  start_date       DateTime
  due_date         DateTime
  department_id    Int?

  roll       rolls?       @relation(fields: [roll_id], references: [id])
  batch      batches?     @relation(fields: [batch_id], references: [id])
  department departments? @relation(fields: [department_id], references: [id])

  size_details sub_batch_size_details[]
  attachments  sub_batch_attachments[]
  rejected     sub_batch_rejected[]
  altered      sub_batch_altered[]
  dept_links   department_sub_batches[]
  worker_logs  worker_logs[]
  workflows    sub_batch_workflows[]
}

model sub_batch_size_details {
  id           Int          @id @default(autoincrement())
  sub_batch_id Int?
  category     String
  pieces       Int
  sub_batch    sub_batches? @relation(fields: [sub_batch_id], references: [id])
}

model sub_batch_attachments {
  id              Int          @id @default(autoincrement())
  sub_batch_id    Int?
  attachment_name String
  quantity        Int
  sub_batch       sub_batches? @relation(fields: [sub_batch_id], references: [id])
}

model sub_batch_rejected {
  id                    Int          @id @default(autoincrement())
  sub_batch_id          Int?
  quantity              Int
  sent_to_department_id Int?
  reason                String
  sub_batch             sub_batches? @relation(fields: [sub_batch_id], references: [id])
  sent_to_department    departments? @relation("RejectedDept", fields: [sent_to_department_id], references: [id])
}

model sub_batch_altered {
  id                    Int          @id @default(autoincrement())
  sub_batch_id          Int?
  quantity              Int
  sent_to_department_id Int?
  reason                String
  sub_batch             sub_batches? @relation(fields: [sub_batch_id], references: [id])
  sent_to_department    departments? @relation("AlteredDept", fields: [sent_to_department_id], references: [id])
}

model departments {
  id   Int    @id @default(autoincrement())
  name String

  remarks String?

  sub_batches     sub_batches[]
  workers         workers[]
  dept_workers    department_workers[]
  dept_batches    department_sub_batches[]
  rejected        sub_batch_rejected[]       @relation("RejectedDept")
  altered         sub_batch_altered[]        @relation("AlteredDept")
  workflow_steps  workflow_steps[]
  sub_batch_steps sub_batch_workflow_steps[]
  supervisor      Supervisor?
}

model department_workers {
  id            Int          @id @default(autoincrement())
  department_id Int?
  worker_id     Int?
  assigned_date DateTime
  department    departments? @relation(fields: [department_id], references: [id])
  worker        workers?     @relation(fields: [worker_id], references: [id])
}

enum DepartmentStage {
  NEW_ARRIVAL
  IN_PROGRESS
  COMPLETED
}

model department_sub_batches {
  id            Int             @id @default(autoincrement())
  department_id Int?
  sub_batch_id  Int?
  stage         DepartmentStage @default(NEW_ARRIVAL) // Kanban column
  is_current    Boolean         @default(false) // only true for active dept
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  assigned_worker_id Int?
  assigned_worker    workers? @relation(fields: [assigned_worker_id], references: [id])

  department departments?                   @relation(fields: [department_id], references: [id])
  sub_batch  sub_batches?                   @relation(fields: [sub_batch_id], references: [id])
  history    department_sub_batch_history[]
}

model clients {
  id      Int     @id @default(autoincrement())
  name    String
  vat_pan String
  address String
  phone   String
  comment String?
}

model workers {
  id                     Int                      @id @default(autoincrement())
  name                   String
  pan                    String
  address                String
  department_id          Int?
  wage_type              String
  wage_rate              Float
  department             departments?             @relation(fields: [department_id], references: [id])
  worker_logs            worker_logs[]
  dept_workers           department_workers[]
  department_assignments department_sub_batches[]
}

model worker_logs {
  id           Int       @id @default(autoincrement())
  worker_id    Int
  sub_batch_id Int
  worker_name  String? // denormalized, for quick reference
  work_date    DateTime? // optional date

  // Work details
  size_category     String?
  particulars       String?
  quantity_received Int?
  quantity_worked   Int?
  unit_price        Float?

  // Relations
  worker    workers     @relation(fields: [worker_id], references: [id])
  sub_batch sub_batches @relation(fields: [sub_batch_id], references: [id])
}

model vendors {
  id      Int       @id @default(autoincrement())
  name    String
  vat_pan String
  address String
  phone   String
  comment String?
  rolls   rolls[]
  batches batches[]
}

model categories {
  id            Int    @id @default(autoincrement())
  category_name String @unique
}

model workflow_templates {
  id          Int              @id @default(autoincrement())
  name        String
  description String?
  steps       workflow_steps[]
  createdAt   DateTime         @default(now())
}

model workflow_steps {
  id                   Int                 @id @default(autoincrement())
  workflow_template_id Int?
  step_index           Int // order: 0,1,2
  department_id        Int
  department           departments?        @relation(fields: [department_id], references: [id])
  workflow_template    workflow_templates? @relation(fields: [workflow_template_id], references: [id])
}

model sub_batch_workflows {
  id                 Int      @id @default(autoincrement())
  sub_batch_id       Int      @unique
  current_step_index Int      @default(0) // where it is in flow
  createdAt          DateTime @default(now())

  sub_batch sub_batches?               @relation(fields: [sub_batch_id], references: [id])
  steps     sub_batch_workflow_steps[]
}

model sub_batch_workflow_steps {
  id                    Int                  @id @default(autoincrement())
  sub_batch_workflow_id Int?
  step_index            Int
  department_id         Int
  department            departments?         @relation(fields: [department_id], references: [id])
  sub_batch_workflow    sub_batch_workflows? @relation(fields: [sub_batch_workflow_id], references: [id])
}

model department_sub_batch_history {
  id                      Int              @id @default(autoincrement())
  department_sub_batch_id Int?
  sub_batch_id            Int?
  from_stage              DepartmentStage?
  to_stage                DepartmentStage
  from_department_id      Int?
  to_department_id        Int?
  action_by_user_id       Int? // optional: who moved it
  reason                  String?
  createdAt               DateTime         @default(now())

  department_sub_batch department_sub_batches? @relation(fields: [department_sub_batch_id], references: [id])
}

model Supervisor {
  id           Int          @id @default(autoincrement())
  name         String
  email        String       @unique
  password     String
  role         Role         @default(SUPERVISOR)
  department   departments? @relation(fields: [departmentId], references: [id])
  departmentId Int?         @unique // ensures only one supervisor per department
  createdAt    DateTime     @default(now())
}

enum Role {
  ADMIN
  SUPERVISOR
}
